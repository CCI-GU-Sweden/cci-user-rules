name: Release & Publish

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  tag-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag
        uses: anothrNick/github-tag-action@1.75.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch
          TAG_PREFIX: v

      - name: Build HTML for this tag (client-side Markdown)
        if: steps.tag.outputs.new_tag != ''
        run: |
          TAG="${{ steps.tag.outputs.new_tag }}"
          mkdir -p "site/versions/${TAG}" site/latest

          cat > "site/versions/${TAG}/index.html" <<'EOF'
          <!doctype html>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width,initial-scale=1">
          <title>CCI User Rules</title>
          <!-- Reuse the main site CSS so it looks the same in the iframe -->
          <link rel="stylesheet" href="https://cci-gu-sweden.github.io/assets/css/style.css">
          <main class="page-content" aria-label="Content">
            <div class="wrapper">
              <h1 id="ver-title">CCI User Rules</h1>
              <div id="md-content"><em>Loadingâ€¦</em></div>
            </div>
          </main>
          <script>
            (async function () {
              const parts = location.pathname.split('/').filter(Boolean);
              const tag = parts[parts.length - 1]; // versions/<TAG>/
              const mdUrl = `https://raw.githubusercontent.com/CCI-GU-Sweden/cci-user-rules/${tag}/CCI_User_Rules.md`;

              const resp = await fetch(mdUrl, { cache: 'no-store' });
              const text = await resp.text();

              document.getElementById('md-content').innerHTML = '<md>'+ text +'</md>';
              document.getElementById('ver-title').textContent = `CCI User Rules ${tag}`;
            })();
          </script>
          <script src="https://cdn.jsdelivr.net/gh/MarketingPipeline/Markdown-Tag/markdown-tag.js"></script>
          EOF

          # keep a /latest/ alias
          cp "site/versions/${TAG}/index.html" site/latest/index.html

          # optional root redirect to /latest/
          cat > site/index.html <<'EOF'
          <!doctype html>
          <meta http-equiv="refresh" content="0;url=./latest/">
          <title>CCI User Rules</title>
          <a href="./latest/">Go to latest</a>
          EOF


      - name: Deploy to gh-pages
        if: steps.tag.outputs.new_tag != ''
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: site
